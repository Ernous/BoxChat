<!DOCTYPE html>
<html>
<head>
    <title>Чат с друзьями</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: #ddd; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Шапка */
        header { background: #333; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .logout-btn { color: #ff6b6b; text-decoration: none; border: 1px solid #ff6b6b; padding: 5px 10px; border-radius: 4px; }
        
        /* Область сообщений */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Стили сообщений */
        .message-container { max-width: 70%; padding: 10px 15px; border-radius: 10px; position: relative; word-wrap: break-word; }
        .message-container.my-msg { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 0; }
        .message-container.other-msg { align-self: flex-start; background: #444; color: #ddd; border-bottom-left-radius: 0; }
        
        .username-label { font-size: 0.75em; opacity: 0.7; margin-bottom: 3px; display: block; }

        /* Поле ввода */
        #input-area { background: #333; padding: 15px; display: flex; gap: 10px; }
        #myMessage { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        #sendBtn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <span>Чат: <b>{{ username }}</b></span>
    <a href="{{ url_for('logout') }}" class="logout-btn">Выйти</a>
</header>

<div id="messages">
    {% for msg in messages %}
        <div class="message-container {% if msg.username == username %}my-msg{% else %}other-msg{% endif %}">
            {% if msg.username != username %}
                <span class="username-label">{{ msg.username }}</span>
            {% endif %}
            {{ msg.content }}
        </div>
    {% endfor %}
</div>

<div id="input-area">
    <input type="text" id="myMessage" placeholder="Введите сообщение...">
    <button id="sendBtn">Send</button>
</div>

<script type="text/javascript">
    const socket = io();
    const currentUser = "{{ username }}"; // Получаем имя текущего юзера из Flask
    const messagesDiv = document.getElementById('messages');

    // Функция прокрутки вниз
    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Прокрутить вниз при загрузке
    scrollToBottom();

    // Обработка входящего сообщения
    socket.on('message', function(data) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message-container');
        
        if (data.username === currentUser) {
            msgDiv.classList.add('my-msg');
            msgDiv.innerText = data.msg;
        } else {
            msgDiv.classList.add('other-msg');
            msgDiv.innerHTML = `<span class="username-label">${data.username}</span>${data.msg}`;
        }
        
        messagesDiv.appendChild(msgDiv);
        scrollToBottom();
    });

    // Отправка сообщения
    function sendMessage() {
        const input = document.getElementById('myMessage');
        const text = input.value;
        if (text.trim() !== "") {
            socket.send(text);
            input.value = '';
        }
    }

    // События клика и нажатия Enter
    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('myMessage').addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });
</script>

</body>
</html>
